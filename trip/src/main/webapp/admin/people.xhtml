<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:jsft="http://jsftemplating.java.net/jsft"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:h="http://xmlns.jcp.org/jsf/html">
    <ui:composition template="/template.xhtml">
        <ui:define name="content">
            <jsft:event type="initPage">
                if (sessionScope.userId == null) {
                    jsft.redirect("/account/login.jsf"); // Not logged in
                } else {
                    viewScope.reqPriv = "admin";
                    if (thePeople == null) {
                        viewScope.thePeople = people.getPeople();
                        viewScope.filtered = util.createList();
                        viewScope.filtered.addAll(thePeople);
                    }
                }
            </jsft:event>
            <jsft:event type="afterCreate" insert="defaultAuth" />

            <p:dataTable id="peeps" widgetVar="peopleTable" var="person" value="#{viewScope.thePeople}" sortBy="#{person.last.concat(person.first)}" filteredValue="#{viewScope.filtered}">
                <f:facet name="header">
                    <h:outputText value="People Manager" />
                    <p:linkButton id="newPerson" value="New Person" style="float:right" href="/trip/person.jsf" />
                </f:facet>
                <p:column width="10" style="text-align:center">
                    <h:outputText value="#{personCount}">
                        <jsft:event type="beforeEncode">
                            personCount = personCount + 1;
                        </jsft:event>
                    </h:outputText>
                </p:column>
                <p:column headerText="Person" width="100" filterBy="#{person.last}, #{person.first} #{person.nickname} #{person.cell} #{person.email}" filterMatchMode="contains">
                    <p:link href="/trip/person.jsf?id=#{person.id.value}">
                        <h:outputText value="#{person.last}, #{person.first}" />
                    </p:link>
                    <h:outputText value=" (#{person.nickname})" rendered="#{person.nickname != null and person.nickname != person.first}" />
                    <br />
                    <h:panelGroup style="font-size:0.65em;display:block;line-height:120%;">
                        <h:outputText value="#{person.cell}" />
                        <h:outputText value="&lt;br /&gt;" escape="false" rendered="#{person.cell != null}" />
                        <h:outputText value=" #{person.email}" />
                    </h:panelGroup>
                </p:column>
                <p:column headerText="Trips" width="100" style="text-align:center" filterBy="#{person.tripIds.toString()}" filterMatchMode="contains">
                    <f:facet name="filter">
                        <p:selectOneMenu onchange="PF('peopleTable').filter()">
                            <f:selectItem itemLabel="All" itemValue="#{null}" noSelectionOption="true" />
                            <f:selectItems value="#{trip.trips}" var="t" itemLabel="#{t.title}" itemValue="#{t.id}" />
                        </p:selectOneMenu>
                    </f:facet>
                    <ui:repeat var="atrip" value="#{person.trips}">
                        <h:panelGroup style="font-size:0.85em">
                            <p:link href="/trip/itinerary.jsf?trip=#{atrip.id}&amp;id=#{person.id.value}">
                                <h:outputText value="#{atrip.title}&lt;br /&gt;" escape="false" />
                            </p:link>
                        </h:panelGroup>
                    </ui:repeat>
                </p:column>
                <!-- p:column headerText="Last Seen" width="100" style="font-size:0.85em">
                    <h:outputText value="#{pass.getCredsByAdmin(person.email, person.id)}">
                        <f:convertDateTime type="localDateTime" pattern="MMM dd, yyyy" />
                    </h:outputText>
                </p:column -->
                <p:column headerText="Notes" width="100" style="font-size:0.85em">
                    <h:outputText value="#{person.notes}" />
                </p:column>
            </p:dataTable>
        </ui:define>
    </ui:composition>
</html>
