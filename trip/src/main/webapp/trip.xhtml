<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:jsft="http://jsftemplating.java.net/jsft"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html">
    <ui:composition template="template.xhtml">
        <ui:define name="content">
            <jsft:event type="initPage">
                if (sessionScope.userId == null) {
                    jsft.redirect("login.jsf"); // Not logged in
                } else {
                    viewScope.theTrip = trip.getTripForUser(trip.trips, theTrip, userId, priv, param.tripId);
                    if (theTrip == null) {
                        jsft.redirect("person.jsf?id=".concat(userId)); // No trips to view
                    } else {
                        viewScope.pilgrims = theTrip.getPeople();
                // FIXME: This doesn't work, need to match tabs b/c some may be missing.
                        activeTab=trip.trips.indexOf(theTrip);
                    }
                }
            </jsft:event>
            <jsft:event type="afterCreate" insert="defaultAuth" />
            <p:dataTable id="peeps" var="personId" value="#{pilgrims}" sortBy="#{person.last}">
                <f:facet name="header">
                    <h:outputText value="#{theTrip.title} Contacts" />
                    <p:commandButton id="editTrip" rendered="#{showAll}" value="Edit Trip" style="float:right">
                        <jsft:event type="command">
                            jsft.redirect("editTrip.jsf?id=".concat(theTrip.id));
                        </jsft:event>
                    </p:commandButton>
                </f:facet>
                <p:column headerText="Name" width="180">
                    <h:outputText value="#{person.first}">
                        <jsft:event type="beforeEncode">
                            person = people.getPerson(personId);
                        </jsft:event>
                    </h:outputText>
                    &nbsp;<h:outputText value="#{person.last}" /><br />
                    <h:panelGroup rendered="#{showAll || person.id.equals(sessionScope.userId)}">
                        <h:outputLink value="transactions.jsf?id=#{person.id}" style="color:#227722;font-weight:bold;font-size:12px;">Balance</h:outputLink>
                        &nbsp;<span style="font-size:12px"> | </span>&nbsp;
                        <h:outputLink value="itinerary.jsf?trip=#{theTrip.id}&amp;id=#{person.id}" style="color:#222277;font-weight:bold;font-size:12px;">Itinerary</h:outputLink>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{showAll}">
                        &nbsp;<span style="font-size:12px"> | </span>&nbsp;
                        <h:outputLink value="person.jsf?id=#{person.id}" style="color:#772222;font-weight:bold;font-size:12px;">Profile</h:outputLink>
                    </h:panelGroup>
                </p:column>
                <p:column headerText="Email" width="230">
                    <h:outputLink value="mailto:#{person.email}" rendered="#{person.email != null}">#{person.email}</h:outputLink><br />
                </p:column>
                <p:column headerText="Phone" width="130">
                    <h:outputText value="#{person.cell}" />
                </p:column>
                <p:column headerText="Address" width="210">
                    <h:outputText rendered="#{showAll || person.id.equals(sessionScope.userId)}" escape="false" value="#{person.address.street}&lt;br/&gt;" />
                    <h:outputText rendered="#{person.address.city != null}" value="#{person.address.city}, " />#{person.address.state} <h:outputText rendered="#{showAll || person.id.equals(sessionScope.userId)}" value="#{person.address.zip}" />
                </p:column>
                <p:column rendered="#{showAll}" headerText="Passport #" width="150">
                    <h:outputText value="#{person.passport.country} #{person.passport.number}" /><br />
                </p:column>
                <p:column rendered="#{showAll}" headerText="Birth Date" width="100" style="text-align:center">
                    <h:outputText value="#{person.birthdate}" />
                </p:column>
            </p:dataTable>
        </ui:define>
    </ui:composition>
</html>
